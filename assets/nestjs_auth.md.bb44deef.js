import{_ as s,c as n,o as a,a as l}from"./app.7d9e6929.js";const C=JSON.parse('{"title":"nest\u7528\u6237\u9274\u6743","description":"","frontmatter":{"sidebar":"auto"},"headers":[{"level":2,"title":"\u751F\u6210token","slug":"\u751F\u6210token"},{"level":2,"title":"\u9A8C\u8BC1token","slug":"\u9A8C\u8BC1token"}],"relativePath":"nestjs/auth.md","lastUpdated":1673347162000}'),p={name:"nestjs/auth.md"},o=l(`<h1 id="nest\u7528\u6237\u9274\u6743" tabindex="-1">nest\u7528\u6237\u9274\u6743 <a class="header-anchor" href="#nest\u7528\u6237\u9274\u6743" aria-hidden="true">#</a></h1><p>\u7528\u6237\u9274\u6743\u4E3B\u8981\u5206\u4E3A\u7ED9\u7528\u6237\u4E0B\u53D1token\u548C\u6821\u9A8Ctoken\u8FD9\u4E24\u6B65\uFF0C\u5E76\u4E14\u91C7\u7528\u6BD4\u8F83\u6D41\u884C\u7684jwt\u5F62\u5F0F</p><h2 id="\u751F\u6210token" tabindex="-1">\u751F\u6210token <a class="header-anchor" href="#\u751F\u6210token" aria-hidden="true">#</a></h2><p><strong>1. nestjs\u96C6\u6210\u4E86jwt\uFF0C\u6211\u4EEC\u9700\u8981\u5B89\u88C5\u5BF9\u5E94\u7684\u4F9D\u8D56</strong></p><div class="language-"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">pnpm add @nestjs/jwt</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p><strong>2. \u5728module\u4E2D\u5BFC\u5165JwtModule\u6A21\u5757</strong></p><div class="language-ts"><span class="copy"></span><pre><code><span class="line"><span style="color:#676E95;font-style:italic;">// Auth.Module.ts</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">JwtModule</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">@nestjs/jwt</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#82AAFF;">Module</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">imports</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">[JwtModule</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">register</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">secret</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">secret</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">signOptions</span><span style="color:#89DDFF;">:{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#F07178;">expiresIn</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">1h</span><span style="color:#89DDFF;">&#39;</span><span style="color:#676E95;font-style:italic;">//300 &#39;7d&#39; token\u6709\u6548\u671F 300\u79D2 1\u5C0F\u65F6 7\u5929</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)]</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">controllers</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">[AuthController]</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">provides</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">[AuthService]</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">AuthModule</span><span style="color:#89DDFF;">{}</span></span>
<span class="line"></span></code></pre></div><p><strong>3. \u5728\u670D\u52A1\u4E2D\u6CE8\u5165JwtService\u670D\u52A1</strong></p><div class="language-ts"><span class="copy"></span><pre><code><span class="line"><span style="color:#676E95;font-style:italic;">// Auth.Service.ts</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">JwtService</span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">@nestjs/jwt</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#82AAFF;">Injectable</span><span style="color:#A6ACCD;">()</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">AuthService</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">constructor</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">readonly</span><span style="color:#A6ACCD;"> jwtService</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;">JwtService</span><span style="color:#89DDFF;">){}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p><strong>4.\u5728\u670D\u52A1\u4E2D\u4F7F\u7528jwtService\u7684sign\u65B9\u6CD5\u751F\u6210token</strong></p><div class="language-ts"><span class="copy"></span><pre><code><span class="line"><span style="color:#676E95;font-style:italic;">// Auth.service.ts</span></span>
<span class="line"><span style="color:#A6ACCD;">async </span><span style="color:#82AAFF;">login</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">name</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">password</span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// 1\u3001\u5224\u65AD\u7528\u6237\u662F\u5426\u5B58\u5728\uFF08\u8C03\u7528\u7528\u6237\u670D\u52A1\u4E2D\u7684\u65B9\u6CD5\u554A\uFF09</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">user</span><span style="color:#89DDFF;">=this.</span><span style="color:#A6ACCD;">userService</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">findByName</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">name</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;">user</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">thorw</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">new</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">NotFoundException</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">\u7528\u6237\u4E0D\u5B58\u5728</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// 2\u3001\u5224\u65AD\u7528\u6237\u5BC6\u7801\u662F\u5426\u6B63\u786E</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">password</span><span style="color:#89DDFF;">!==</span><span style="color:#A6ACCD;">user</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">password</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;font-style:italic;">throw</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">new</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">BadRequestException</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">\u7528\u6237\u5BC6\u7801\u9519\u8BEF</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// 3\u3001\u751F\u6210token</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">payload</span><span style="color:#89DDFF;">={</span></span>
<span class="line"><span style="color:#F07178;">        id</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">user</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">id</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">name</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">token</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#89DDFF;">=this.</span><span style="color:#A6ACCD;">jwtService</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sign</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">payload</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// 4\u3001\u8FD4\u56DE\u7528\u6237\u4FE1\u606F\u548Ctoken</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">...</span><span style="color:#A6ACCD;">payload</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">token</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h2 id="\u9A8C\u8BC1token" tabindex="-1">\u9A8C\u8BC1token <a class="header-anchor" href="#\u9A8C\u8BC1token" aria-hidden="true">#</a></h2><div class="tip custom-block"><p class="custom-block-title">passport</p><p>passport\u4E2D\u63D0\u4F9B\u4E86\u5F88\u591A\u9A8C\u8BC1\u7528\u6237\u8EAB\u4EFD\u7684\u65B9\u6CD5\uFF0C\u8FD9\u4E9B\u65B9\u6CD5\u5728passport\u4E2D\u79F0\u4E3A\u7B56\u7565</p></div><p><strong>1.nestjs\u4E2D\u96C6\u6210\u4E86passport\uFF0C\u9700\u8981\u5B89\u88C5\u5BF9\u5E94\u7684\u4F9D\u8D56\u5305\u548C\u5BF9\u5E94\u7684\u7B56\u7565passport-jwt</strong></p><div class="language-shell"><span class="copy"></span><pre><code><span class="line"><span style="color:#676E95;font-style:italic;"># \u5B89\u88C5\u4F9D\u8D56\u5305</span></span>
<span class="line"><span style="color:#A6ACCD;">pnpm add @nestjs/passport passport passport-jwt</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># \u5B89\u88C5\u5BF9\u5E94\u7684\u7C7B\u578B\u6587\u4EF6</span></span>
<span class="line"><span style="color:#A6ACCD;">pnpm add -D @types/passport @types/passport-jwt</span></span>
<span class="line"></span></code></pre></div><p><strong>2.\u5728module\u4E2D\u5BFC\u5165PassportModule\u6A21\u5757</strong></p><div class="language-ts"><span class="copy"></span><pre><code><span class="line"><span style="color:#676E95;font-style:italic;">// Auth.Module.ts</span></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#82AAFF;">Module</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">imports</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">[</span></span>
<span class="line"><span style="color:#A6ACCD;">        JwtModule</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">register</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">secret</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">hello</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">signOptions</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">expiresIn</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">1h</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">},</span><span style="color:#676E95;font-style:italic;">//\u8BBE\u7F6E\u8FC7\u671F\u65F6\u95F4</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    PassportModule</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">register</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">defaultStrategy</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">jwt</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#676E95;font-style:italic;">//\u8BBE\u7F6E\u9ED8\u8BA4\u7B56\u7565\u4E3Ajwt</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    ]</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"></span></code></pre></div><p><strong>3.\u6DFB\u52A0\u7B56\u7565\u6587\u4EF6</strong> \u4E3A\u4E86\u65B9\u4FBF\u62D3\u5C55\uFF0C\u6211\u4EEC\u5EFA\u7ACB\u4E00\u4E2Astratagies\u6587\u4EF6\u5939\u7528\u6237\u5B58\u653E\u6240\u6709\u7684\u7B56\u7565\u6587\u4EF6,\u7136\u540E\u65B0\u5EFAjwt\u7684\u7B56\u7565\u6587\u4EF6jwt.stratagy.ts</p><div class="language-ts"><span class="copy"></span><pre><code><span class="line"><span style="color:#676E95;font-style:italic;">// jwt.stratagy.ts</span></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#82AAFF;">Injectable</span><span style="color:#A6ACCD;">()</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">JwtStratagy</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">extends</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">PassportStrategy</span><span style="color:#A6ACCD;">(Stratage)</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">constructor</span><span style="color:#89DDFF;">(){</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">super</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">            jwtFromRequest</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">ExtractJwt</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">fromAuthHeaderAsBearerToken</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">,</span><span style="color:#676E95;font-style:italic;">//\u4ECEHeader\u4E2D\u83B7\u53D6BearerToken</span></span>
<span class="line"><span style="color:#F07178;">            ignoreExpiration</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">false</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">            secretOrKey</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">hello</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#676E95;font-style:italic;">//\u8DDF\u751F\u6210token\u662F\u7684\u5BC6\u94A5\u4FDD\u6301\u4E00\u81F4</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div>`,19),e=[o];function t(c,r,y,D,F,A){return a(),n("div",null,e)}var d=s(p,[["render",t]]);export{C as __pageData,d as default};
